<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LoRaWAN Key Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-connected { background-color: #28a745; }
        .status-disconnected { background-color: #dc3545; }
        .device-card {
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .device-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .device-card.selected {
            border: 2px solid #007bff;
            background-color: #f8f9fa;
        }
        .migration-progress {
            display: none;
        }
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .connection-card {
            min-height: 120px;
        }
        .log-container {
            max-height: 300px;
            overflow-y: auto;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
        }
        .setup-modal .modal-dialog {
            max-width: 800px;
        }
        .setup-steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2rem;
        }
        .setup-step {
            flex: 1;
            text-align: center;
            position: relative;
        }
        .setup-step:not(:last-child)::after {
            content: '';
            position: absolute;
            top: 50%;
            right: -50%;
            width: 100%;
            height: 2px;
            background: #dee2e6;
            z-index: 1;
        }
        .setup-step.active::after {
            background: #0d6efd;
        }
        .setup-step.completed::after {
            background: #198754;
        }
        .step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: #dee2e6;
            color: #6c757d;
            font-weight: bold;
            position: relative;
            z-index: 2;
        }
        .setup-step.active .step-circle {
            background: #0d6efd;
            color: white;
        }
        .setup-step.completed .step-circle {
            background: #198754;
            color: white;
        }
        .url-builder {
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 0.5rem;
            background: #f8f9fa;
        }
        .url-component {
            display: inline-block;
            margin: 0.125rem;
        }
        .url-component input {
            border: 1px solid #ced4da;
            border-radius: 0.25rem;
            padding: 0.25rem 0.5rem;
            font-family: monospace;
        }
        .url-component.protocol input {
            width: 80px;
            background: #e9ecef;
            color: #495057;
        }
        .url-component.hostname input {
            min-width: 200px;
        }
        .url-component.port input {
            width: 60px;
            background: #e9ecef;
            color: #495057;
        }
        .url-preview {
            font-family: monospace;
            font-size: 0.9rem;
            color: #0d6efd;
            margin-top: 0.5rem;
            padding: 0.5rem;
            background: #f8f9fa;
            border-radius: 0.25rem;
            border: 1px solid #dee2e6;
        }
        .connection-test {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 0.5rem;
            border: 2px dashed #dee2e6;
        }
        .connection-test.testing {
            border-color: #ffc107;
            background-color: #fff9c4;
        }
        .connection-test.success {
            border-color: #198754;
            background-color: #d1e7dd;
        }
        .connection-test.error {
            border-color: #dc3545;
            background-color: #f8d7da;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="bi bi-key"></i> LoRa Key Manager
            </a>
            <div class="navbar-nav ms-auto">
                <button class="btn btn-outline-light btn-sm me-3" onclick="openSetupModal()" title="Reconfigure LNS Settings">
                    <i class="bi bi-gear"></i> Setup
                </button>
                <span class="navbar-text" id="connectionStatus">
                    Checking connections...
                </span>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Setup/Onboarding Modal -->
        <div class="modal fade setup-modal" id="setupModal" tabindex="-1" aria-labelledby="setupModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="setupModalLabel">
                            <i class="bi bi-gear"></i> Setup LoRaWAN Migration Service
                        </h5>
                    </div>
                    <div class="modal-body">
                        <!-- Setup Progress -->
                        <div class="setup-steps" id="setupSteps">
                            <div class="setup-step active" data-step="1">
                                <div class="step-circle">1</div>
                                <div class="step-label mt-2">Welcome</div>
                            </div>
                            <div class="setup-step" data-step="2">
                                <div class="step-circle">2</div>
                                <div class="step-label mt-2">Source LNS</div>
                            </div>
                            <div class="setup-step" data-step="3">
                                <div class="step-circle">3</div>
                                <div class="step-label mt-2">Target LNS</div>
                            </div>
                            <div class="setup-step" data-step="4">
                                <div class="step-circle">4</div>
                                <div class="step-label mt-2">Complete</div>
                            </div>
                        </div>

                        <!-- Step 1: Welcome -->
                        <div class="setup-content" id="setupStep1">
                            <div class="text-center">
                                <i class="bi bi-router display-1 text-primary mb-4"></i>
                                <h3>Welcome to LoRaWAN Migration Service</h3>
                                <p class="lead">This wizard will guide you through configuring your source and target LoRaWAN Network Servers (LNS) for device migration.</p>
                                
                                <div class="row mt-4">
                                    <div class="col-md-6">
                                        <div class="card h-100">
                                            <div class="card-body text-start">
                                                <h5><i class="bi bi-download text-primary"></i> Source LNS</h5>
                                                <p>Configure your existing ChirpStack server where devices currently reside.</p>
                                                <ul class="list-unstyled">
                                                    <li><i class="bi bi-check text-success"></i> Extract device configurations</li>
                                                    <li><i class="bi bi-check text-success"></i> Retrieve application keys</li>
                                                    <li><i class="bi bi-check text-success"></i> Export session data</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card h-100">
                                            <div class="card-body text-start">
                                                <h5><i class="bi bi-upload text-success"></i> Target LNS</h5>
                                                <p>Configure your destination ChirpStack server for migrated devices.</p>
                                                <ul class="list-unstyled">
                                                    <li><i class="bi bi-check text-success"></i> Create device entries</li>
                                                    <li><i class="bi bi-check text-success"></i> Configure application keys</li>
                                                    <li><i class="bi bi-check text-success"></i> Activate devices</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Step 2: Source LNS Configuration -->
                        <div class="setup-content d-none" id="setupStep2">
                            <h4><i class="bi bi-download"></i> Configure Source LNS</h4>
                            <p class="text-muted">Enter the connection details for your existing ChirpStack server.</p>
                            
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i>
                                <strong>Buoy Fish Configuration Examples:</strong>
                                <ul class="mb-0 mt-2">
                                    <li><strong>Old ChirpStack (Source):</strong> <code>http://20.121.50.53:8080</code></li>
                                    <li><strong>Note:</strong> Use the IP address, not <code>old.console.buoy.fish</code></li>
                                    <li><strong>Protocol:</strong> HTTP (not HTTPS) for port 8080</li>
                                </ul>
                            </div>

                            <form id="sourceLNSForm">
                                <div class="row">
                                    <div class="col-md-8">
                                        <div class="mb-3">
                                            <label for="sourceName" class="form-label">LNS Name</label>
                                            <input type="text" class="form-control" id="sourceName" placeholder="e.g., Old Production LNS" required>
                                            <div class="form-text">A friendly name to identify this LNS</div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="sourceLorawanVersion" class="form-label">LoRaWAN Version</label>
                                            <select class="form-select" id="sourceLorawanVersion" required>
                                                <option value="1.0.x" selected>1.0.x (Legacy)</option>
                                                <option value="1.1.x">1.1.x (Modern)</option>
                                            </select>
                                            <div class="form-text">Used for proper AppKey extraction</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Server URL</label>
                                    <div class="url-builder">
                                        <div class="d-flex align-items-center flex-wrap">
                                            <div class="url-component protocol">
                                                <input type="text" id="sourceProtocol" value="http://" readonly>
                                            </div>
                                            <div class="url-component hostname">
                                                <input type="text" id="sourceHostname" placeholder="20.121.50.53" required>
                                            </div>
                                            <div class="url-component">
                                                <span>:</span>
                                            </div>
                                            <div class="url-component port">
                                                <input type="number" id="sourcePort" value="8080" min="1" max="65535">
                                            </div>
                                        </div>
                                        <div class="mt-2">
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input" type="checkbox" id="sourceUseSSL" onchange="updateSourceProtocol()">
                                                <label class="form-check-label" for="sourceUseSSL">
                                                    <i class="bi bi-shield-lock"></i> SSL/TLS Enabled
                                                </label>
                                            </div>
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input" type="checkbox" id="sourceUseDefaultPort" checked onchange="updateSourcePort()">
                                                <label class="form-check-label" for="sourceUseDefaultPort">
                                                    Use default port
                                                </label>
                                            </div>
                                        </div>
                                        <div class="url-preview" id="sourceUrlPreview">http://20.121.50.53:8080</div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="sourceApiKey" class="form-label">API Key</label>
                                    <div class="input-group">
                                        <input type="password" class="form-control font-monospace" id="sourceApiKey" placeholder="eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9..." required>
                                        <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordVisibility('sourceApiKey')">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                    </div>
                                    <div class="form-text">JWT token for API access</div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="sourceTenantId" class="form-label">Tenant ID</label>
                                            <input type="text" class="form-control font-monospace" id="sourceTenantId" placeholder="52f14cd4-c6f1-4fbd-8f87-4025e1d49242" required>
                                            <div class="form-text">UUID format tenant identifier</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="sourceTenantName" class="form-label">Tenant Name</label>
                                            <input type="text" class="form-control" id="sourceTenantName" value="ChirpStack" required>
                                            <div class="form-text">Human-readable tenant name</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="connection-test" id="sourceConnectionTest">
                                    <div class="d-flex align-items-center">
                                        <i class="bi bi-info-circle text-info me-2"></i>
                                        <span>Connection will be tested in Step 4</span>
                                    </div>
                                </div>
                            </form>
                        </div>

                        <!-- Step 3: Target LNS Configuration -->
                        <div class="setup-content d-none" id="setupStep3">
                            <h4><i class="bi bi-upload"></i> Configure Target LNS</h4>
                            <p class="text-muted">Enter the connection details for your destination ChirpStack server.</p>
                            
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i>
                                <strong>Buoy Fish Target Configuration:</strong>
                                <ul class="mb-0 mt-2">
                                    <li><strong>New ChirpStack (Target):</strong> <code>https://console.buoy.fish:443</code></li>
                                    <li><strong>Type:</strong> Helium Community (custom implementation)</li>
                                    <li><strong>Protocol:</strong> HTTPS for secure connection</li>
                                </ul>
                            </div>

                            <form id="targetLNSForm">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="targetName" class="form-label">LNS Name</label>
                                            <input type="text" class="form-control" id="targetName" placeholder="e.g., New Production LNS" required>
                                            <div class="form-text">A friendly name to identify this LNS</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="targetType" class="form-label">LNS Type</label>
                                            <select class="form-select" id="targetType" required>
                                                <option value="standard">Standard ChirpStack</option>
                                                <option value="helium">Helium Community</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Server URL</label>
                                    <div class="url-builder">
                                        <div class="d-flex align-items-center flex-wrap">
                                            <div class="url-component protocol">
                                                <input type="text" id="targetProtocol" value="https://" readonly>
                                            </div>
                                            <div class="url-component hostname">
                                                <input type="text" id="targetHostname" placeholder="console.buoy.fish" value="console.buoy.fish" required>
                                            </div>
                                            <div class="url-component">
                                                <span>:</span>
                                            </div>
                                            <div class="url-component port">
                                                <input type="number" id="targetPort" value="443" min="1" max="65535">
                                            </div>
                                        </div>
                                        <div class="mt-2">
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input" type="checkbox" id="targetUseSSL" checked onchange="updateTargetProtocol()">
                                                <label class="form-check-label" for="targetUseSSL">
                                                    <i class="bi bi-shield-lock"></i> SSL/TLS Enabled
                                                </label>
                                            </div>
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input" type="checkbox" id="targetUseDefaultPort" checked onchange="updateTargetPort()">
                                                <label class="form-check-label" for="targetUseDefaultPort">
                                                    Use default port
                                                </label>
                                            </div>
                                        </div>
                                        <div class="url-preview" id="targetUrlPreview">https://console.buoy.fish:443</div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="targetApiKey" class="form-label">API Key</label>
                                    <div class="input-group">
                                        <input type="password" class="form-control font-monospace" id="targetApiKey" placeholder="eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9..." required>
                                        <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordVisibility('targetApiKey')">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                    </div>
                                    <div class="form-text">JWT token for API access</div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="targetTenantId" class="form-label">Tenant ID</label>
                                            <input type="text" class="form-control font-monospace" id="targetTenantId" placeholder="e1d293fb-6dc5-4214-a23a-94696f17f82f" required>
                                            <div class="form-text">UUID format tenant identifier</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="targetTenantName" class="form-label">Tenant Name</label>
                                            <input type="text" class="form-control" id="targetTenantName" value="buoy" required>
                                            <div class="form-text">Human-readable tenant name</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="connection-test" id="targetConnectionTest">
                                    <div class="d-flex align-items-center">
                                        <i class="bi bi-info-circle text-info me-2"></i>
                                        <span>Connection will be tested in Step 4</span>
                                    </div>
                                </div>
                            </form>
                        </div>

                        <!-- Step 4: Test & Complete -->
                        <div class="setup-content d-none" id="setupStep4">
                            <h4><i class="bi bi-shield-check"></i> Test & Complete Setup</h4>
                            <p class="text-muted">Validate your LNS connections with the provided tenant information.</p>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0"><i class="bi bi-download"></i> Source LNS</h6>
                                        </div>
                                        <div class="card-body">
                                            <div id="sourceFinalTest" class="connection-test">
                                                <div class="d-flex align-items-center">
                                                    <div class="spinner-border spinner-border-sm text-primary me-2 d-none" id="sourceFinalSpinner"></div>
                                                    <i class="bi bi-wifi text-muted me-2" id="sourceFinalIcon"></i>
                                                    <span id="sourceFinalText">Ready to test...</span>
                                                </div>
                                                <div id="sourceFinalResult" class="mt-2 d-none"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0"><i class="bi bi-upload"></i> Target LNS</h6>
                                        </div>
                                        <div class="card-body">
                                            <div id="targetFinalTest" class="connection-test">
                                                <div class="d-flex align-items-center">
                                                    <div class="spinner-border spinner-border-sm text-primary me-2 d-none" id="targetFinalSpinner"></div>
                                                    <i class="bi bi-wifi text-muted me-2" id="targetFinalIcon"></i>
                                                    <span id="targetFinalText">Ready to test...</span>
                                                </div>
                                                <div id="targetFinalResult" class="mt-2 d-none"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="text-center mt-4">
                                <button type="button" class="btn btn-primary btn-lg" onclick="testAndComplete()" id="testCompleteBtn">
                                    <i class="bi bi-shield-check"></i> Test Connections & Complete Setup
                                </button>
                            </div>

                            <div id="setupSuccess" class="d-none mt-4">
                                <div class="text-center">
                                    <i class="bi bi-check-circle-fill display-1 text-success mb-4"></i>
                                    <h3>Setup Complete!</h3>
                                    <p class="lead">Your LoRaWAN Migration Service is now configured and ready to use.</p>
                                    
                                    <div class="row mt-4">
                                        <div class="col-md-4">
                                            <div class="card text-center">
                                                <div class="card-body">
                                                    <i class="bi bi-search display-4 text-primary"></i>
                                                    <h6 class="mt-2">Discover Devices</h6>
                                                    <p class="small text-muted">Scan your source LNS for devices</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="card text-center">
                                                <div class="card-body">
                                                    <i class="bi bi-arrow-right-circle display-4 text-success"></i>
                                                    <h6 class="mt-2">Migrate Devices</h6>
                                                    <p class="small text-muted">Transfer devices to your target LNS</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="card text-center">
                                                <div class="card-body">
                                                    <i class="bi bi-graph-up display-4 text-info"></i>
                                                    <h6 class="mt-2">Monitor Progress</h6>
                                                    <p class="small text-muted">Track migration status and results</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <button type="button" class="btn btn-primary mt-3" onclick="completeSetup()">
                                        <i class="bi bi-arrow-right"></i> Continue to Dashboard
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="previousStep()" id="prevBtn" style="display: none;">
                            <i class="bi bi-arrow-left"></i> Previous
                        </button>
                        <button type="button" class="btn btn-primary" onclick="nextStep()" id="nextBtn">
                            Next <i class="bi bi-arrow-right"></i>
                        </button>
                        <button type="button" class="btn btn-success d-none" onclick="completeSetup()" id="completeBtn">
                            <i class="bi bi-check-circle"></i> Complete Setup
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Alert Container -->
        <div id="alertContainer"></div>

        <!-- Stats and Connection Status -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card stats-card">
                    <div class="card-body text-center">
                        <h3 class="card-title" id="deviceCount">0</h3>
                        <p class="card-text">Total Devices</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card connection-card">
                    <div class="card-body">
                        <h6 class="card-title">Old LNS Connection</h6>
                        <p class="card-text" id="oldLNSStatus">
                            <span class="status-indicator status-disconnected"></span>
                            Checking...
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card connection-card">
                    <div class="card-body">
                        <h6 class="card-title">New LNS Connection</h6>
                        <p class="card-text" id="newLNSStatus">
                            <span class="status-indicator status-disconnected"></span>
                            Checking...
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Actions -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Device Management</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <button class="btn btn-info w-100 mb-2" onclick="discoverDevices()">
                                    <i class="bi bi-search"></i> Discover Devices from Old LNS
                                </button>
                            </div>
                            <div class="col-md-6">
                                <button class="btn btn-primary w-100 mb-2" onclick="loadDevices()">
                                    <i class="bi bi-arrow-clockwise"></i> Refresh Device List
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Migration Configuration -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Migration Configuration</h5>
                    </div>
                    <div class="card-body">
                        <form id="migrationForm">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="targetApplication" class="form-label">Target Application</label>
                                        <select class="form-select" id="targetApplication">
                                            <option value="">Loading applications...</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="targetDeviceProfile" class="form-label">Target Device Profile</label>
                                        <select class="form-select" id="targetDeviceProfile">
                                            <option value="">Loading profiles...</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-12">
                                    <h6>Migration Options</h6>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="migrateDeviceProfile" checked>
                                        <label class="form-check-label" for="migrateDeviceProfile">
                                            Migrate Device Profile
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="migrateDecoder" checked>
                                        <label class="form-check-label" for="migrateDecoder">
                                            Migrate Decoder Script
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="migrateSessionKeys">
                                        <label class="form-check-label" for="migrateSessionKeys">
                                            Migrate Session Keys
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="removeFromOldLNS">
                                        <label class="form-check-label" for="removeFromOldLNS">
                                            Remove from Old LNS after Migration
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="skipFcntCheck" checked>
                                        <label class="form-check-label" for="skipFcntCheck">
                                            Disable Frame Counter Validation
                                            <i class="bi bi-info-circle text-primary ms-1" data-bs-toggle="tooltip" data-bs-placement="top" 
                                               title="When enabled, devices can transmit without strict frame counter validation. Recommended for migrations to avoid initial connectivity issues. When disabled, provides better security by enforcing sequential frame counters."></i>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bulk Migration by Application -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-collection"></i> Bulk Migration by Application
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i>
                            Select a source application from your old LNS to migrate all its devices to the target application in your new LNS.
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="sourceApplication" class="form-label">Source Application (Old LNS)</label>
                                    <select class="form-select" id="sourceApplication" onchange="loadApplicationDevices()">
                                        <option value="">Select source application...</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="bulkTargetApplication" class="form-label">Target Application (New LNS)</label>
                                    <select class="form-select" id="bulkTargetApplication">
                                        <option value="">Select target application...</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="bulkTargetDeviceProfile" class="form-label">Target Device Profile (New LNS)</label>
                                    <select class="form-select" id="bulkTargetDeviceProfile">
                                        <option value="">Select target device profile...</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mt-3">
                            <div class="col-md-12">
                                <h6>Bulk Migration Options</h6>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="bulkSkipFcntCheck" checked>
                                    <label class="form-check-label" for="bulkSkipFcntCheck">
                                        Disable Frame Counter Validation
                                        <i class="bi bi-info-circle text-primary ms-1" data-bs-toggle="tooltip" data-bs-placement="top" 
                                           title="When enabled, devices can transmit without strict frame counter validation. Recommended for migrations to avoid initial connectivity issues. When disabled, provides better security by enforcing sequential frame counters."></i>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div id="applicationDevicesPreview" class="d-none">
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="alert alert-light">
                                        <h6 class="mb-1">Application Devices Preview</h6>
                                        <p class="mb-1" id="applicationDeviceCount">0 devices found</p>
                                        <small class="text-muted" id="applicationDeviceDetails"></small>
                                    </div>
                                </div>
                                <div class="col-md-4 text-end">
                                    <button class="btn btn-warning" onclick="migrateApplicationDevices()" id="bulkMigrateBtn" disabled>
                                        <i class="bi bi-arrow-right-circle"></i> Migrate All Devices
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Device Selection and Migration -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">Individual Device Selection</h5>
                        <div>
                            <button class="btn btn-sm btn-outline-primary" onclick="selectAllDevices()">Select All</button>
                            <button class="btn btn-sm btn-outline-secondary ms-2" onclick="clearSelection()">Clear Selection</button>
                            <button class="btn btn-success ms-2" onclick="migrateSelectedDevices()" id="migrateBtn" disabled>
                                <i class="bi bi-arrow-right-circle"></i> Migrate Selected
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Search Bar -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                                    <input type="text" class="form-control" id="deviceSearch" placeholder="Search by device name or DevEUI..." oninput="filterDevices()">
                                </div>
                            </div>
                            <div class="col-md-6 text-end">
                                <span id="deviceCount" class="text-muted">0 devices</span>
                            </div>
                        </div>
                        
                        <!-- Device Table -->
                        <div class="table-responsive">
                            <table class="table table-hover" id="deviceTable">
                                <thead class="table-light">
                                    <tr>
                                        <th width="50">
                                            <input type="checkbox" class="form-check-input" id="selectAllCheckbox" onchange="toggleSelectAll()">
                                        </th>
                                        <th>Device Name</th>
                                        <th>DevEUI</th>
                                        <th>Application</th>
                                        <th>Device Profile</th>
                                        <th>Last Updated</th>
                                        <th width="100">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="deviceTableBody">
                                    <tr>
                                        <td colspan="7" class="text-center text-muted py-5">
                                            <i class="bi bi-devices display-4"></i>
                                            <br><br>No devices found. Click "Discover Devices" to sync from your old LNS.
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Migration Progress -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card migration-progress" id="migrationProgress">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Migration Progress</h5>
                    </div>
                    <div class="card-body">
                        <div class="progress mb-3">
                            <div class="progress-bar" role="progressbar" style="width: 0%" id="progressBar">0%</div>
                        </div>
                        <div class="log-container" id="migrationLog"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Migration History -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Recent Migration History</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Device EUI</th>
                                        <th>Status</th>
                                        <th>Started</th>
                                        <th>Completed</th>
                                        <th>Error</th>
                                    </tr>
                                </thead>
                                <tbody id="migrationHistoryTable">
                                    <tr>
                                        <td colspan="5" class="text-center text-muted">No migration history</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="app.js"></script>
</body>
</html> 